function animate(){var moving=!1;for(keys.SHIFT&&player.stamina>0?(player.stamina-=4,moveSpeed=4):(player.stamina<=99&&player.stamina++,moveSpeed=2),frameCount++>=1e3&&(frameCount=0),i=0;i<spawns.length;i++)if(spawns[i].cd--<=0){spawns[i].cd=120;var nextElement=spawns[i].nextElement;spawns[i].nextElement=spawns[i].availableTypes[Math.floor(4*Math.random())],enemies.push({x:spawns[i].x,y:spawns[i].y,w:5,h:5,hp:10,speed:Math.random()+.5,type:nextElement})}ctx.save(),ctx.clearRect(0,0,width,height),drawCollidibles(),drawPickups(),drawProjectiles(),drawSpawns(),drawEnemies(),drawFinish(),collideEnemies(),checkFinish(),moving=checkMove("LEFT","x",!0)||moving,moving=checkMove("RIGHT","x",!1)||moving,moving=checkMove("UP","y",!0)||moving,moving=checkMove("DOWN","y",!1)||moving;var index=collision(player,enemies);index>-1&&die(),pickup(),collideProjecties(),keys.SPACE&&player.cd<=0&&player.type?(drawPlant("Shoot"),shoot()):drawPlant(player.cd>10?"Shoot":moving===!0?frameCount%15>10?2:frameCount%15>5?1:3:1),player.cd>0&&player.cd--,ctx.restore(),stop===!1&&(animateID=window.requestAnimationFrame(animate))}function checkMove(direction,moveProperty,invert){if(keys[direction]){if(player.lastDirection=direction,invert?player[moveProperty]-=moveSpeed:player[moveProperty]+=moveSpeed,index=collision(player,collidibles),!(index>-1&&player.type!==collidibles[index].type))return!0;invert?player[moveProperty]+=moveSpeed:player[moveProperty]-=moveSpeed}return!1}function collideProjecties(){for(i=0;i<projectiles.length;i++){var index=collision(projectiles[i],collidibles);index>-1&&collidibles[index].type!==player.type?projectiles.splice(i,1):(index=collision(projectiles[i],enemies),index>-1&&(player.type===enemies[index].type?(enemies[index].w+=2,enemies[index].h+=2):(projectiles.splice(i,1),enemies.splice(index,1))))}}function collideEnemies(){for(i=0;i<enemies.length;i++){var o=enemies[i];o.x+=o.x<player.x?o.speed:-o.speed;var index=collision(o,collidibles);-1===index||o.type===collidibles[index].type||(o.x-=o.x<player.x?o.speed:-o.speed),o.y+=o.y<player.y?o.speed:-o.speed,index=collision(o,collidibles),-1===index||o.type===collidibles[index].type||(o.y-=o.y<player.y?o.speed:-o.speed)}}function finished(){currentLevel++,goLevel(currentLevel)}function checkFinish(){player.x+player.w>finish.x&&player.x<finish.x+finish.w&&player.y+player.h>finish.y&&player.y<finish.y+finish.h&&finished()}function shoot(){var p={x:player.x,y:player.y,w:3,h:3,color:colors[player.type],tX:0,tY:0};p=modDirection(p),projectiles.push(p),player.cd=shootCD}function modDirection(p){return(keys.RIGHT||p.RIGHT)&&(p.x+=player.w,p.y+=10,p.tX=projectileSpeed),(keys.LEFT||p.LEFT)&&(p.y+=10,p.tX=0-projectileSpeed),(keys.UP||p.UP)&&(p.tY=0-projectileSpeed,p.x+=player.w/2),(keys.DOWN||p.DOWN)&&(p.y+=player.h,p.tY=projectileSpeed,p.x+=player.w/2),0===p.tX&&0===p.tY&&(p[player.lastDirection]=!0,p=modDirection(p)),p}function collision(obj,arr){var i;for(i=0;i<arr.length;i++){var coll=arr[i];if(obj.x+obj.w>coll.x&&obj.x<coll.x+coll.w&&obj.y+obj.h>coll.y&&obj.y<coll.y+coll.h)return i}return-1}function pickup(){var i;for(i=0;i<pickups.length;i++){var o=pickups[i];if(player.x+player.w>o.x&&player.x<o.x+o.w&&player.y+player.h>o.y&&player.y<o.y+o.h){gain(o.type),pickups.splice(i,1);break}}}function gain(item){elements.push({type:item,color:colors[item]}),1===elements.length&&(player.type=item)}function get(id){return document.getElementById(id)}function die(){window.cancelAnimationFrame(animateID),stop=!0,get("btn").classList.remove("hidden"),get("dead").classList.remove("hidden"),get("content").classList.add("disabled"),get("btn").focus(),get("dead").classList.remove("disabled"),get("btn").innerHTML="Try again",get("dead").style.top="579px"}function again(){goLevel(currentLevel)}function goLevel(level){var s=window.location.toString();window.location=s.split("?")[0]+"?autoStart=1&level="+level}function drawPickups(){for(i=0;i<pickups.length;i++){var o=pickups[i];rect(o.x,o.y,o.w,o.h,colors[o.type])}}function drawCollidibles(){for(i=0;i<collidibles.length;i++){var o=collidibles[i];rect(o.x,o.y,o.w,o.h,colors[o.type])}}function drawEnemies(){for(i=0;i<enemies.length;i++){var o=enemies[i];o.w<enemyWidth&&(o.w++,o.h++),rect(o.x,o.y,o.w,o.h,colors[o.type],"purple")}}function drawProjectiles(){for(i=0;i<projectiles.length;i++){var o=projectiles[i];o.x+=o.tX,o.y+=o.tY,rect(o.x,o.y,o.w,o.h,o.color)}}function drawSpawns(){for(i=0;i<spawns.length;i++)ctx.strokeStyle="black",ctx.fillStyle=colors[spawns[i].nextElement],ctx.beginPath(),ctx.arc(spawns[i].x,spawns[i].y,spawns[i].w,0,2*Math.PI,!0),ctx.stroke(),ctx.fill()}function drawFinish(){ctx.fillStyle="gray",ctx.font="20pt Helvetica",ctx.fillText("Exit",finish.x+55,finish.y+45)}function rect(x,y,w,h,color,lineColor){ctx.strokeStyle=lineColor||"black",ctx.fillStyle=color,ctx.beginPath(),ctx.rect(x,y,w,h),ctx.stroke(),ctx.fill()}function drawPlant(state){var x=player.x,y=player.y;for(keys.LEFT||"LEFT"===player.lastDirection?flipImage(root["planty"+state],x,y):ctx.drawImage(root["planty"+state],x,y),i=0;i<elements.length;i++){var e=elements[i],w=player.type===e.type?6:5;rect(x+5*i,y,w,w,e.color)}rect(x,y+player.h,player.w*(player.stamina/100),3,"yellow")}function flipImage(image,x,y){x=-1*image.width+0-x,ctx.save(),ctx.scale(-1,1),ctx.drawImage(image,x,y,image.width,image.height),ctx.restore()}function showL1Instructions(){get("l1i").style.display="block",get("collect").style.top="46px",get("avoid").style.top="251px",get("go").style.top="545px"}function hideL1Instructions(){get("l1i").display="none"}function setKey(event,status){var code=event.keyCode;switch(code){case 32:keys.SPACE=status,stop===!1&&event.preventDefault();break;case 37:case 65:keys.LEFT=status,event.preventDefault();break;case 38:case 87:keys.UP=status,event.preventDefault();break;case 39:case 68:keys.RIGHT=status,event.preventDefault();break;case 40:case 83:keys.DOWN=status,event.preventDefault();break;case 16:keys.SHIFT=status;break;case 49:case 50:case 51:case 52:var a=3-(52-code);elements[a]&&(player.type=elements[a].type);break;case 97:case 98:case 99:case 100:var a=3-(100-code);elements[a]&&(player.type=elements[a].type);break;default:console.log(code)}}function onLoad(){var u=location.search;if(u.indexOf("autoStart")>-1){c.classList.remove("disabled"),get("btn").classList.add("hidden");var q=qs(location.search);currentLevel=parseInt(q.level),1===currentLevel?showL1Instructions():hideL1Instructions(),collidibles=levels[currentLevel].collidibles,spawns=levels[currentLevel].spawns,pickups=levels[currentLevel].pickups,finish=levels[currentLevel].finish[0],player=levels[currentLevel].player,stop=!1,animateID=window.requestAnimationFrame(animate)}}function qs(qs){qs=qs.split("+").join(" ");for(var tokens,params={},re=/[?&]?([^=]+)=([^&]*)/g;tokens=re.exec(qs);)params[decodeURIComponent(tokens[1])]=decodeURIComponent(tokens[2]);return params}var c=document.getElementById("game"),ctx=c.getContext("2d"),width=c.width,height=c.height,animateID,stop=!0,i,root=this,planty1=new Image;planty1.src="./images/planty1.gif";var planty2=new Image;planty2.src="./images/planty2.gif";var planty3=new Image;planty3.src="./images/planty3.gif";var plantyShoot=new Image;plantyShoot.src="./images/plantyShoot.gif";var player,moveSpeed=0,projectileSpeed=5,shootCD=20,enemyWidth=20,keys=[],frameCount=0,currentLevel=1,levels=[];levels[1]={collidibles:[{x:0,y:0,w:10,h:height},{x:width-10,y:0,w:10,h:height},{x:0,y:height-10,w:width,h:10},{x:0,y:0,w:width,h:10},{x:10,y:400,w:80,h:10,type:"water"},{x:400,y:300,w:10,h:80,type:"water"},{x:480,y:300,w:10,h:80,type:"water"},{x:410,y:370,w:80,h:10,type:"water"},{x:400,y:300,w:80,h:10,type:"water"},{x:210,y:490,w:180,h:10,type:"water"},{x:210,y:490,w:10,h:100,type:"water"},{x:390,y:490,w:10,h:100,type:"water"}],spawns:[{x:400,y:250,w:10,h:10,availableTypes:["fire","earth","spirit","air"],nextElement:"earth",cd:120}],pickups:[{x:40,y:40,w:10,h:10,type:"water"}],finish:[{x:225,y:510,w:160,h:70}],player:{x:100,y:100,h:59,w:37,cd:0,lastDirection:"RIGHT",stamina:100,type:null}},levels[2]={collidibles:[{x:0,y:0,w:10,h:height},{x:width-10,y:0,w:10,h:height},{x:0,y:height-10,w:width,h:10},{x:0,y:0,w:width,h:10},{x:80,y:400,w:10,h:190,type:"air"},{x:10,y:400,w:80,h:10,type:"water"},{x:100,y:150,w:400,h:10,type:"earth"},{x:300,y:10,w:10,h:150,type:"earth"},{x:610,y:490,w:180,h:10,type:"fire"},{x:600,y:390,w:10,h:200,type:"spirit"}],spawns:[{x:350,y:370,w:10,h:10,availableTypes:["fire","earth","spirit","air"],nextElement:"air",cd:120}],pickups:[{x:280,y:40,w:10,h:10,type:"water"},{x:40,y:height-30,w:10,h:10,type:"fire"},{x:320,y:40,w:10,h:10,type:"air"}],finish:[{x:620,y:510,w:160,h:70}],player:{x:300,y:200,h:59,w:37,cd:0,lastDirection:"RIGHT",stamina:100,type:null}},levels[3]={collidibles:[{x:0,y:0,w:10,h:height},{x:width-10,y:0,w:10,h:height},{x:0,y:height-10,w:width,h:10},{x:0,y:0,w:width,h:10},{x:10,y:80,w:80,h:10,type:"air"},{x:80,y:10,w:10,h:80,type:"air"},{x:80,y:400,w:10,h:190,type:"earth"},{x:600,y:350,w:10,h:250,type:"spirit"},{x:600,y:80,w:10,h:80,type:"earth"},{x:600,y:160,w:80,h:10,type:"earth"},{x:10,y:400,w:80,h:10,type:"water"},{x:400,y:300,w:10,h:80,type:"water"},{x:480,y:300,w:10,h:80,type:"water"},{x:410,y:370,w:80,h:10,type:"water"},{x:400,y:300,w:80,h:10,type:"water"},{x:610,y:400,w:180,h:10,type:"fire"},{x:610,y:430,w:180,h:10,type:"air"},{x:610,y:460,w:180,h:10,type:"earth"},{x:610,y:490,w:180,h:10,type:"water"}],spawns:[{x:400,y:250,w:10,h:10,availableTypes:["fire","earth","spirit","air","water"],nextElement:"fire",cd:120}],pickups:[{x:40,y:40,w:10,h:10,type:"water"},{x:40,y:height-30,w:10,h:10,type:"fire"},{x:440,y:335,w:10,h:10,type:"earth"},{x:620,y:140,w:10,h:10,type:"air"}],finish:[{x:620,y:510,w:160,h:70}],player:{x:100,y:100,h:59,w:37,cd:0,lastDirection:"RIGHT",stamina:100,type:null}},levels[4]={collidibles:[{x:0,y:0,w:10,h:height},{x:width-10,y:0,w:10,h:height},{x:0,y:height-10,w:width,h:10},{x:0,y:0,w:width,h:10},{x:10,y:100,w:100,h:10,type:"fire"},{x:400,y:10,w:10,h:580,type:"fire"},{x:600,y:10,w:10,h:150,type:"earth"},{x:600,y:150,w:190,h:10,type:"earth"},{x:600,y:250,w:10,h:250,type:"earth"},{x:600,y:490,w:10,h:100,type:"air"},{x:600,y:490,w:190,h:10,type:"air"},{x:500,y:300,w:50,h:10,type:"spirit"},{x:550,y:250,w:60,h:10,type:"spirit"},{x:550,y:250,w:10,h:60,type:"spirit"},{x:500,y:300,w:10,h:60,type:"spirit"},{x:100,y:500,w:100,h:10,type:"water"},{x:100,y:10,w:10,h:500,type:"water"},{x:200,y:10,w:10,h:500,type:"water"}],spawns:[{x:500,y:540,w:10,h:10,availableTypes:["fire","air","earth"],nextElement:"fire",cd:120},{x:300,y:40,w:10,h:10,availableTypes:["fire","water"],nextElement:"water",cd:120}],pickups:[{x:40,y:40,w:10,h:10,type:"water"},{x:760,y:40,w:10,h:10,type:"fire"},{x:580,y:290,w:10,h:10,type:"earth"},{x:150,y:450,w:10,h:10,type:"air"}],finish:[{x:620,y:510,w:160,h:70}],player:{x:500,y:100,h:59,w:37,cd:0,lastDirection:"RIGHT",stamina:100,type:null}},levels[5]={collidibles:[{x:0,y:0,w:10,h:height},{x:width-10,y:0,w:10,h:height},{x:0,y:height-10,w:width,h:10},{x:0,y:0,w:width,h:10},{x:10,y:80,w:300,h:10,type:"fire"},{x:160,y:490,h:100,w:10,type:"water"},{x:190,y:490,h:100,w:10,type:"fire"},{x:220,y:490,h:100,w:10,type:"earth"},{x:250,y:490,h:100,w:10,type:"air"},{x:10,y:480,h:10,w:260,type:"spirit"}],spawns:[],pickups:[],finish:[{x:0,y:510,w:50,h:50}],player:{x:10,y:10,h:59,w:37,cd:0,lastDirection:"RIGHT",stamina:100,type:null}};var collidibles,spawns,pickups,finish,elements=[],colors={fire:"#FA6900",water:"#046D8B",earth:"#784800",air:"ghostwhite",spirit:"black"},enemies=[],projectiles=[];document.addEventListener("keydown",function(e){setKey(e,!0)}),document.addEventListener("keyup",function(e){setKey(e,!1)}),window.addEventListener("blur",function(){keys=[]});